

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>L2 Stack and Drivers &mdash; Zephyr Project Documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/zephyr-custom.css" type="text/css" />
  

  
        <link rel="copyright" title="Copyright" href="../../copyright.html"/>
    <link rel="top" title="Zephyr Project Documentation" href="../../index.html"/>
        <link rel="up" title="Networking" href="networking.html"/>
        <link rel="next" title="Network Management API" href="network-management-api.html"/>
        <link rel="prev" title="Network Connectivity API" href="networking-api-usage.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Zephyr Project
          

          
          </a>

          
            
            
              <div class="version">
                1.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/introducing_zephyr.html">Introducing Zephyr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boards/boards.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel/kernel.html">Zephyr Kernel Primer (version 2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../application/application.html">Application Development Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../porting/porting.html">Porting Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../drivers/drivers.html">Device Drivers and Device Model</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystems.html">Subsystems</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../bluetooth/bluetooth.html">Bluetooth</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c_library.html">Standard C Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.html">Logging</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="networking.html">Networking</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="ip-stack-migrate.html">Migrating from Zephyr v1.6 IP Stack to v1.7</a></li>
<li class="toctree-l3"><a class="reference internal" href="ip-stack-architecture.html">IP Stack Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking-api-usage.html">Network Connectivity API</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">L2 Stack and Drivers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#l2-layer-api">L2 layer API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#network-device-drivers">Network Device drivers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="network-management-api.html">Network Management API</a></li>
<li class="toctree-l3"><a class="reference internal" href="buffers.html">Network Buffers</a></li>
<li class="toctree-l3"><a class="reference internal" href="qemu_setup.html">Networking with Qemu</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../power_management.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sensor.html">Sensor Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell.html">Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../test/ztest.html">Test Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usb/usb.html">USB device stack</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../samples/samples.html">Samples and Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/kconfig/index.html">Configuration Options Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/code.html">Contributing Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSING.html">Licensing of Zephyr Project components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary of Terms</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Zephyr Project</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../subsystems.html">Subsystems</a> &raquo;</li>
        
          <li><a href="networking.html">Networking</a> &raquo;</li>
        
      <li>L2 Stack and Drivers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/subsystems/networking/l2-and-drivers.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="l2-stack-and-drivers">
<span id="l2-and-drivers"></span><h1>L2 Stack and Drivers<a class="headerlink" href="#l2-stack-and-drivers" title="Permalink to this headline">¶</a></h1>
<p>The L2 stack is designed to hide the whole networking link-layer part
and the related device drivers from the higher IP stack. This is made
through a unique object known as the &#8220;network interface object&#8221;:
<code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">net_if</span></code> declared in <cite>include/net/net_if.h</cite>.</p>
<p>The IP layer is unaware of implementation details beyond the net_if
object and the generic API provided by the L2 layer in
<cite>include/net/net_l2.h</cite> as <code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">net_l2</span></code>.</p>
<p>Only the L2 layer can talk to the device driver, linked to the net_if
object. The L2 layer dictates the API provided by the device driver,
specific for that device, and optimized for working together.</p>
<p>Currently, there are L2 layers for Ethernet, IEEE 802.15.4 Soft-MAC,
Bluetooth IPSP, and a dummy one, which is a generic layer example that
can be used as a template for writing a new one.</p>
<div class="section" id="l2-layer-api">
<h2>L2 layer API<a class="headerlink" href="#l2-layer-api" title="Permalink to this headline">¶</a></h2>
<p>In order to create an L2 layer, or even a driver for a specific L2
layer, one needs to understand how the IP layer interacts with it and
how the L2 layer is supposed to behave. The generic L2 API has 3
functions:</p>
<ul class="simple">
<li>recv: All device drivers, once they receive a packet which they put
into a <code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">net_nbuf</span></code>, will push this buffer to the IP
core stack via <code class="xref c c-func docutils literal"><span class="pre">net_recv_data()</span></code>. At this point, the IP core
stack does not know what to do with it. Instead, it passes the
buffer along to the L2 stack&#8217;s recv() function for handling. The L2
stack does what it needs to do with the packet, for example, parsing
the link layer header, or handling link-layer only packets. The
recv() function will return NET_DROP in case of an erroneous packet,
NET_OK if the packet was fully consumed by the L2, or NET_CONTINUE
if the IP stack should then handle it as an IP packet.</li>
<li>reserve: Prior to creating any network buffer content, the Zephyr
core stack needs to know how much dedicated buffer space is needed
for the L2 layer (for example, space for the link layer header). This
reserve function returns the number of bytes needed.</li>
<li>send: Similar to recv, the IP core stack will call this function to
actually send a packet. All relevant link-layer content will be
generated and added by this function.  As for recv, send returns a
verdict and can decide to drop the packet via NET_DROP if something
wrong happened, or will return NET_OK.</li>
</ul>
</div>
<div class="section" id="network-device-drivers">
<h2>Network Device drivers<a class="headerlink" href="#network-device-drivers" title="Permalink to this headline">¶</a></h2>
<p>Network device drivers fully follows Zephyr device driver model as a
basis. Please refer to <a class="reference internal" href="../../drivers/drivers.html#device-drivers"><span class="std std-ref">Device Drivers and Device Model</span></a>.</p>
<p>There are, however, two differences:</p>
<ul class="simple">
<li>the driver_api pointer must point to a valid <code class="xref c c-type docutils literal"><span class="pre">struct</span>
<span class="pre">net_if_api</span></code> pointer.</li>
<li>The network device driver must use NET_DEVICE_INIT_INSTANCE(). This
macro will call the DEVICE_AND_API_INIT() macro, and also
instantiate a unique <code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">net_if</span></code> related to the created
device driver instance.</li>
</ul>
<p>Implementing a network device driver depends on the L2 stack it
belongs to: Ethernet, IEEE 802.15.4, etc. In the next section, we will
describe how a device driver should behave when receiving or sending a
packet. The rest is really hardware dependent and thus does not need
to be detailed here.</p>
<div class="section" id="ethernet-device-driver">
<h3>Ethernet device driver<a class="headerlink" href="#ethernet-device-driver" title="Permalink to this headline">¶</a></h3>
<p>On reception, it is up to the device driver to fill-in the buffer with
as many data fragments as required. The buffer itself is a
<code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">net_nbuf</span></code> and should be allocated through
<code class="xref c c-func docutils literal"><span class="pre">net_nbuf_get_reserve_rx(0)()</span></code>. Then all fragments will be
allocated through <code class="xref c c-func docutils literal"><span class="pre">net_nbuf_get_reserve_data(0)()</span></code>. Of course
the amount of required fragments depends on the size of the received
packet and on the size of a fragment, which is given by
<cite>CONFIG_NET_NBUF_DATA_SIZE</cite>.</p>
<p>Note that it is not up to the device driver to decide on the
link-layer space to be reserved in the buffer. Hence the 0 given as
parameter here. The Ethernet L2 layer will update such information
once the packet&#8217;s Ethernet header has been successfully parsed.</p>
<p>In case <code class="xref c c-func docutils literal"><span class="pre">net_recv_data()</span></code> call fails, it will be up to the
device driver to un-reference the buffer via
<code class="xref c c-func docutils literal"><span class="pre">net_nbuf_unref()</span></code>.</p>
<p>On sending, it is up to the device driver to send the buffer all at
once, with all the fragments.</p>
<p>In case of a fully successful packet transmission only, the device
driver must un-reference the buffer via <cite>net_nbuf_unref()</cite>.</p>
<p>Each Ethernet device driver will need, in the end, to call
<cite>NET_DEVICE_INIT_INSTANCE()</cite> like this:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">NET_DEVICE_INIT_INSTANCE</span><span class="p">(...,</span>
                         <span class="n">CONFIG_ETH_INIT_PRIORITY</span>
                         <span class="o">&amp;</span><span class="n">the_valid_net_if_api_instance</span><span class="p">,</span>
                         <span class="n">ETHERNET_L2</span><span class="p">,</span>
                         <span class="n">NET_L2_GET_CTX_TYPE</span><span class="p">(</span><span class="n">ETHERNET_L2</span><span class="p">),</span> <span class="mi">1500</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="ieee-802-15-4-device-driver">
<h3>IEEE 802.15.4 device driver<a class="headerlink" href="#ieee-802-15-4-device-driver" title="Permalink to this headline">¶</a></h3>
<p>Device drivers for IEEE 802.15.4 L2 work basically the same as for
Ethernet.  What has been described above, especially for recv, applies
here as well.  There are two specific differences however:</p>
<ul class="simple">
<li>It requires a dedicated device driver API: <code class="xref c c-type docutils literal"><span class="pre">struct</span>
<span class="pre">ieee802154_radio_api</span></code>, which overloads <code class="xref c c-type docutils literal"><span class="pre">struct</span>
<span class="pre">net_if_api</span></code>. This is because 802.15.4 L2 needs more from the device
driver than just send and recv functions.  This dedicated API is
declared in <cite>include/net/ieee802154_radio.h</cite>. Each and every IEEE
802.15.4 device driver must provide a valid pointer on such
relevantly filled-in API structure.</li>
<li>Sending a packet is slightly particular. IEEE 802.15.4 sends
relatively small frames, 127 bytes all inclusive: frame header,
payload and frame checksum.  Buffer fragments are meant to fit such
frame size limitation.  But a buffer containing an IPv6/UDP packet
might have more than one fragment. In the Ethernet device driver, it
is up to the driver to handle all fragments. IEEE 802.15.4 drivers
handle only one fragment at a time.  This is why the <code class="xref c c-type docutils literal"><span class="pre">struct</span>
<span class="pre">ieee802154_radio_api</span></code> requires a tx function pointer which differs
from the <code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">net_if_api</span></code> send function pointer.
Instead, the IEEE 802.15.4 L2, provides a generic
<code class="xref c c-func docutils literal"><span class="pre">ieee802154_radio_send()</span></code> meant to be given as
<code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">net_if</span></code> send function. It turn, the implementation
of <code class="xref c c-func docutils literal"><span class="pre">ieee802154_radio_send()</span></code> will ensure the same behavior:
sending one fragment at a time through <code class="xref c c-type docutils literal"><span class="pre">struct</span>
<span class="pre">ieee802154_radio_api</span></code> tx function, and un-referencing the buffer
only when all the transmission were successful.</li>
</ul>
<p>Each IEEE 802.15.4 device driver, in the end, will need to call
<cite>NET_DEVICE_INIT_INSTANCE()</cite> that way:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">NET_DEVICE_INIT_INSTANCE</span><span class="p">(...,</span>
                         <span class="n">the_device_init_prio</span><span class="p">,</span>
                         <span class="o">&amp;</span><span class="n">the_valid_ieee802154_radio_api_instance</span><span class="p">,</span>
                         <span class="n">IEEE802154_L2</span><span class="p">,</span>
                         <span class="n">NET_L2_GET_CTX_TYPE</span><span class="p">(</span><span class="n">IEEE802154_L2</span><span class="p">),</span> <span class="mi">125</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="network-management-api.html" class="btn btn-neutral float-right" title="Network Management API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="networking-api-usage.html" class="btn btn-neutral" title="Network Connectivity API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; <a href="../../copyright.html">Copyright</a> 2015-2017 Zephyr Project members and individual contributors..
      Last updated on Mar 14, 2017.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.7.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>