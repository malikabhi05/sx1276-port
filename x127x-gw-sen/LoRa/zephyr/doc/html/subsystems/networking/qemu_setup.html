

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Networking with Qemu &mdash; Zephyr Project Documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/zephyr-custom.css" type="text/css" />
  

  
        <link rel="copyright" title="Copyright" href="../../copyright.html"/>
    <link rel="top" title="Zephyr Project Documentation" href="../../index.html"/>
        <link rel="up" title="Networking" href="networking.html"/>
        <link rel="next" title="Power Management" href="../power_management.html"/>
        <link rel="prev" title="Network Buffers" href="buffers.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Zephyr Project
          

          
          </a>

          
            
            
              <div class="version">
                1.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/introducing_zephyr.html">Introducing Zephyr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boards/boards.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel/kernel.html">Zephyr Kernel Primer (version 2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../application/application.html">Application Development Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../porting/porting.html">Porting Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../drivers/drivers.html">Device Drivers and Device Model</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystems.html">Subsystems</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../bluetooth/bluetooth.html">Bluetooth</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c_library.html">Standard C Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.html">Logging</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="networking.html">Networking</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="ip-stack-migrate.html">Migrating from Zephyr v1.6 IP Stack to v1.7</a></li>
<li class="toctree-l3"><a class="reference internal" href="ip-stack-architecture.html">IP Stack Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking-api-usage.html">Network Connectivity API</a></li>
<li class="toctree-l3"><a class="reference internal" href="l2-and-drivers.html">L2 Stack and Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="network-management-api.html">Network Management API</a></li>
<li class="toctree-l3"><a class="reference internal" href="buffers.html">Network Buffers</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Networking with Qemu</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="#basic-setup">Basic Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setting-up-nat-masquerading-to-access-internet">Setting up NAT/masquerading to access Internet</a></li>
<li class="toctree-l4"><a class="reference internal" href="#network-connection-between-two-qemu-vms">Network connection between two QEMU VMs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../power_management.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sensor.html">Sensor Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell.html">Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../test/ztest.html">Test Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usb/usb.html">USB device stack</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../samples/samples.html">Samples and Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/kconfig/index.html">Configuration Options Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/code.html">Contributing Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSING.html">Licensing of Zephyr Project components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary of Terms</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Zephyr Project</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../subsystems.html">Subsystems</a> &raquo;</li>
        
          <li><a href="networking.html">Networking</a> &raquo;</li>
        
      <li>Networking with Qemu</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/subsystems/networking/qemu_setup.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="networking-with-qemu">
<span id="id1"></span><h1>Networking with Qemu<a class="headerlink" href="#networking-with-qemu" title="Permalink to this headline">¶</a></h1>
<p>This page describes how to set up a &#8220;virtual&#8221; networking between a (Linux) host
and a Zephyr application running in a QEMU virtual machine (built for Zephyr
targets like qemu_x86, qemu_cortex_m3, etc.) In this example, the
<code class="docutils literal"><span class="pre">echo_server</span></code> sample application from Zephyr source distribution is run in
QEMU. The QEMU instance is connected to Linux host using serial port and SLIP is
used to transfer data between Zephyr and Linux (over a chain of virtual
connections).</p>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<p>On the Linux Host you need to fetch Zephyr net-tools project, which is located
in a separate git repository:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> git clone https://gerrit.zephyrproject.org/r/net-tools
<span class="gp">$</span> <span class="nb">cd</span> net-tools
<span class="gp">$</span> make
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you get error about AX_CHECK_COMPILE_FLAG, install package autoconf-archive
package on Debian/Ubuntu.</p>
</div>
</div>
<div class="section" id="basic-setup">
<h2>Basic Setup<a class="headerlink" href="#basic-setup" title="Permalink to this headline">¶</a></h2>
<p>For the steps below, you will need at least 4 terminal windows:</p>
<ul class="simple">
<li>Terminal #1 is your usual Zephyr development terminal, with Zephyr environment
initialized.</li>
<li>Terminals #2, #3, #4 - fresh terminal windows with net-tools being the current
directory (&#8220;cd net-tools&#8221;)</li>
</ul>
<div class="section" id="step-1-create-helper-socket">
<h3>Step 1 - Create helper socket<a class="headerlink" href="#step-1-create-helper-socket" title="Permalink to this headline">¶</a></h3>
<p>Before starting QEMU with network emulation, a unix socket for the emulation
should be created.</p>
<p>In terminal #2, type:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ./loop-socat.sh
</pre></div>
</div>
</div>
<div class="section" id="step-2-start-tap-device-routing-daemon">
<h3>Step 2 - Start TAP device routing daemon<a class="headerlink" href="#step-2-start-tap-device-routing-daemon" title="Permalink to this headline">¶</a></h3>
<p>In terminal #3, type:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo ./loop-slip-tap.sh
</pre></div>
</div>
</div>
<div class="section" id="step-3-start-app-in-qemu">
<h3>Step 3 - Start app in QEMU<a class="headerlink" href="#step-3-start-app-in-qemu" title="Permalink to this headline">¶</a></h3>
<p>Build and start the <code class="docutils literal"><span class="pre">echo_server</span></code> sample application.</p>
<p>In terminal #1, type:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> samples/net/echo_server
<span class="gp">$</span> make pristine <span class="o">&amp;&amp;</span> make qemu
</pre></div>
</div>
<p>If you see error from QEMU about unix:/tmp/slip.sock, it means you missed Step 1
above.</p>
</div>
<div class="section" id="step-4-run-apps-on-host">
<h3>Step 4 - Run apps on host<a class="headerlink" href="#step-4-run-apps-on-host" title="Permalink to this headline">¶</a></h3>
<p>Now in terminal #4, you can run various tools to communicate with the
application running in QEMU.</p>
<p>You can start with pings:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ping <span class="m">192</span>.0.2.1
<span class="gp">$</span> ping6 <span class="m">2001</span>:db8::1
</pre></div>
</div>
<p>For example, using netcat (&#8220;nc&#8221;) utility, connecting using UDP:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">echo</span> foobar <span class="p">|</span> nc -6 -u <span class="m">2001</span>:db8::1 <span class="m">4242</span>
<span class="go">foobar</span>
</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">echo</span> foobar <span class="p">|</span> nc -u <span class="m">192</span>.0.2.1 <span class="m">4242</span>
<span class="go">foobar</span>
</pre></div>
</div>
<p>If echo_server is compiled with TCP support (now enabled by default for
echo_server sample, CONFIG_NET_TCP=y):</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">echo</span> foobar <span class="p">|</span> nc -6 -q2 <span class="m">2001</span>:db8::1 <span class="m">4242</span>
<span class="go">foobar</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You will need to Ctrl+C manually.</p>
</div>
<p>You can also use the telnet command to achieve the above.</p>
</div>
</div>
<div class="section" id="setting-up-nat-masquerading-to-access-internet">
<h2>Setting up NAT/masquerading to access Internet<a class="headerlink" href="#setting-up-nat-masquerading-to-access-internet" title="Permalink to this headline">¶</a></h2>
<p>To access Internet from a custom application running in a QEMU, NAT
(masquerading) should be set up for QEMU&#8217;s source address. Assuming 192.0.2.1 is
used, the following command should be run as root:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> iptables -t nat -A POSTROUTING -j MASQUERADE -s <span class="m">192</span>.0.2.1
</pre></div>
</div>
<p>Additionally, IPv4 forwarding should be enabled on host, and you may need to
check that other firewall (iptables) rules don&#8217;t interfere with masquerading.</p>
</div>
<div class="section" id="network-connection-between-two-qemu-vms">
<h2>Network connection between two QEMU VMs<a class="headerlink" href="#network-connection-between-two-qemu-vms" title="Permalink to this headline">¶</a></h2>
<p>Unlike VM-Host setup described above, VM-VM setup is automatic - for sample
applications which support such mode such as the echo_server and echo_client
samples, you will need 2 terminal windows, set up for Zephyr development.</p>
<div class="section" id="terminal-1">
<h3>Terminal #1:<a class="headerlink" href="#terminal-1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> samples/net/echo_server
<span class="gp">$</span> make server
</pre></div>
</div>
<p>This will start QEMU, waiting for connection from a client QEMU.</p>
</div>
<div class="section" id="terminal-2">
<h3>Terminal #2:<a class="headerlink" href="#terminal-2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> samples/net/echo_client
<span class="gp">$</span> make client
</pre></div>
</div>
<p>This will start 2nd QEMU instance, and you should see logging of data sent and
received in both.</p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../power_management.html" class="btn btn-neutral float-right" title="Power Management" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="buffers.html" class="btn btn-neutral" title="Network Buffers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; <a href="../../copyright.html">Copyright</a> 2015-2017 Zephyr Project members and individual contributors..
      Last updated on Mar 14, 2017.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.7.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>